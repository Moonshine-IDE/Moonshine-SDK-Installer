name: SUB - Build on Windows

on:
  workflow_dispatch:
    inputs:
      env:
        description: "An Environment"
        required: true
        type: choice
        options:
          - development
          - production
      version:
        description: "A Version"
        required: true
        type: string
      caching:
        description: "Use caching"
        required: true
        type: boolean
        default: false

  workflow_call:
    inputs:
      env:
        description: "An Environment"
        required: true
        type: string
      version:
        description: "A Version"
        required: true
        type: string
      caching:
        description: "Use caching"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: "windows-latest"

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - uses: krdlab/setup-haxe@v1
      with:
        haxe-version: 4.2.5

    - uses: joshtynjala/setup-apache-flex-action@v2
      with:
        flex-version: "4.16.1"
        air-version: "33.1"
        accept-air-license: true

    - name: Install NSIS plugin nsProcess
      working-directory: MoonshineSDKInstaller/build
      run: |
        Invoke-RestMethod -Uri "https://nsis.sourceforge.io/mediawiki/images/2/2f/ExecCmd.zip" -OutFile ExecCmd.zip
        7z x ExecCmd.zip -o'ExecCmd' -y
        mv ExecCmd\ExecCmd.dll "C:\Program Files (x86)\NSIS\Plugins\x86-unicode\ExecCmd.dll"

    - name: Build with Ant  
      shell: cmd      
      run: >
        ant 
        -buildfile MoonshineSDKInstaller/build/build.xml all 
        -DHAXEPATH="C:\hostedtoolcache\windows\haxe\4.2.5\x64"
        -DHAXE_HOME="C:\hostedtoolcache\windows\haxe\4.2.5\x64\lib"
        -DNSIS_HOME="C:\Program Files (x86)\NSIS"
        -Dapp.version=${{ inputs.version }}
        -Dbuild.is.signed=false 
        -Dbuild.is.development=${{ inputs.env != 'production' }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MoonshineSDKInstaller
        path: MoonshineSDKInstaller/build/bin/app